name: Functional Tests

on:
  workflow_call:
    inputs:
      timeout-minutes:
        description: "Timeout for the entire job in minutes"
        required: false
        type: number
        default: 60
  workflow_dispatch:
    inputs:
      timeout-minutes:
        description: "Timeout for the entire job in minutes"
        required: false
        type: number
        default: 60

jobs:
  functional-tests:
    name: Functional Tests (GPU)
    runs-on: [self-hosted, gpu]
    timeout-minutes: ${{ inputs.timeout-minutes }}

    steps:
      - uses: actions/checkout@v4

      - name: Check GPU availability
        run: nvidia-smi

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .
          pip install pytest

      - name: Run functional ops tests
        run: |
          pytest tests/functional_tests/ops/ \
            tests/functional_tests/compilation/ \
            -v --tb=short -q

      - name: Run inference tests
        run: |
          pytest tests/functional_tests/inference/ \
            -v --tb=short -s

      - name: Run serving tests
        run: |
          pytest tests/functional_tests/serving/ \
            -v --tb=short -s \
            --timeout=600
