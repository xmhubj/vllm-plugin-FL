name: Functional Tests

on:
  workflow_call:
    inputs:
      timeout-minutes:
        description: "Timeout for the entire job in minutes"
        required: false
        type: number
        default: 60
  workflow_dispatch:
    inputs:
      timeout-minutes:
        description: "Timeout for the entire job in minutes"
        required: false
        type: number
        default: 60

jobs:
  functional-tests:
    name: Functional Tests (GPU)
    runs-on: [self-hosted, nvidia, gpu-8]
    timeout-minutes: ${{ inputs.timeout-minutes }}
    container:
      image: vllm-plugin-fl:ci
      volumes:
        - /data:/data
      options: >-
        --privileged
        --gpus all
        --ipc=host
        --device=/dev/infiniband
        --shm-size 512g
        --ulimit memlock=-1
        --cap-add=SYS_PTRACE

    steps:
      - uses: actions/checkout@v4

      - name: Check GPU availability
        run: nvidia-smi

      - name: Install FlagGems
        run: |
          pip install -U scikit-build-core==0.11 pybind11 ninja cmake
          git clone https://github.com/flagos-ai/FlagGems /tmp/FlagGems
          pip install --no-build-isolation /tmp/FlagGems

      - name: Install FlagCX
        run: |
          git clone https://github.com/flagos-ai/FlagCX.git /tmp/FlagCX
          cd /tmp/FlagCX
          git checkout v0.9.0
          git submodule update --init --recursive
          make USE_NVIDIA=1
          echo "FLAGCX_PATH=/tmp/FlagCX" >> $GITHUB_ENV
          cd plugin/torch/
          FLAGCX_ADAPTOR=nvidia pip install --no-build-isolation .

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .
          pip install pytest

      - name: Run functional ops tests
        run: |
          pytest tests/functional_tests/ops/ \
            tests/functional_tests/compilation/ \
            -v --tb=short -q

      - name: Run inference tests
        run: |
          pytest tests/functional_tests/inference/ \
            -v --tb=short -s

      - name: Run serving tests
        run: |
          pytest tests/functional_tests/serving/ \
            -v --tb=short -s \
            --timeout=600
